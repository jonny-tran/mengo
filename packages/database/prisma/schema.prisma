generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  INSTRUCTOR
  STUDENT
}

enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  DONE
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  name           String?
  memberships    Membership[]
  assignedTasks  Task[]          @relation("TaskAssignee")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  hashedRefreshToken String?
  authOtps           AuthOtp[]
}

model Organization {
  id          String        @id @default(uuid())
  name        String        @unique
  memberships Membership[]
  projects    Project[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Membership {
  id             String        @id @default(uuid())
  userId         String
  organizationId String
  role           Role
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

model Project {
  id             String        @id @default(uuid())
  organizationId String
  name           String
  brief          String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  epics          Epic[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId])
  @@unique([name, organizationId])
}

model Epic {
  id        String   @id @default(uuid())
  projectId String
  title     String
  order     Int
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@unique([title, projectId])
}

model Task {
  id                String       @id @default(uuid())
  epicId            String
  title             String
  description       String?
  order             Int
  status            TaskStatus   @default(BACKLOG)
  assigneeId        String?
  assignee          User?        @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  hintMetacognitive String?
  hintConceptual    String?
  hintKeywords      String?
  epic              Epic         @relation(fields: [epicId], references: [id], onDelete: Cascade)
  checklistItems    ChecklistItem[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([epicId])
  @@index([assigneeId])
  @@unique([title, epicId])
}

model ChecklistItem {
  id        String   @id @default(uuid())
  taskId    String
  text      String
  isCompleted Boolean @default(false)
  order     Int      @default(0)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@unique([text, taskId])
}

model AuthOtp {
  id        String   @id @default(uuid())
  hashedOtp String 
  expiresAt DateTime 
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}


